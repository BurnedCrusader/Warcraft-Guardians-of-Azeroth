namespace = WCMDV

#############################
# 	Medivh in first war		#
#############################

#You open dark portal and let orcs come in
narrative_event = {
    id = WCMDV.100
	
	title = EVTTITLE_WCMDV_100
	desc = EVTDESC_WCMDV_100
	picture = GFX_evt_medivh_opening_dark_portal
	border = GFX_event_narrative_frame_diplomacy
	
	is_triggered_only = yes
	
	trigger = {
	    NOT = { has_global_flag = medivh_openned_dark_portal_flag }
		has_character_flag = is_medivh
		year = 583
	}
	
	immediate = {
	    set_global_flag = medivh_openned_dark_portal_flag
		narrative_event = { id = WCMDV.101 days = 1 }
	}
	
	option = {
		name = EVTOPTA_WCMDV_100
	}
}

#Between good or evil
narrative_event = {
    id = WCMDV.101
	
	title = EVTTITLE_WCMDV_101
	desc = EVTDESC_WCMDV_101
	picture = GFX_evt_possessed_medivh
	border = GFX_event_narrative_frame_war
	
	is_triggered_only = yes
	
	immediate = {
	    set_character_flag = in_fight_with_sargeras
		if = { #If Aegwynn and Arcanagos is alive and capable
			limit = { 
			    c_60578 = {
					is_alive = yes
					is_incapable = no
				}
				c_62605 = {
					is_alive = yes
					is_incapable = no
				}
			}
			narrative_event = { id = WCMDV.102 days = 1 }
		}
		else = { #If they not
			narrative_event = { id = WCMDV.104 days = 4 }
			set_global_flag = aegwynn_dead
		}
	}
	
	option = { #Side with cool kids
	    name = EVTOPTA_WCMDV_101
		
		set_character_flag = sided_with_sargeras
		
		piety = -1
	}
	
	option = { #No I am good
	    name = EVTOPTB_WCMDV_101
		
		set_character_flag = sided_with_good
		
		piety = 1
	}
}

#Aegwynn and Arcanagos
narrative_event = {
	id = WCMDV.102
	
	title = EVTTITLE_WCMDV_102
	desc = EVTDESC_WCMDV_102
	picture = GFX_evt_aegwynn_spell
	border = GFX_event_narrative_frame_war
	
	is_triggered_only = yes
	
	portrait = c_60578
	
	immediate = {
	    c_62605 = {
		    opinion = { modifier = opinion_possessed_by_evil who = ROOT }
		}
		c_60578 = {
			opinion = { modifier = opinion_possessed_by_evil who = ROOT }
		}
	}
	
	option = {
		trigger = { has_character_flag = sided_with_sargeras }
		name = EVTOPTA_WCMDV_102
		narrative_event = { id = WCMDV.103 }
	}
	
	option = {
		trigger = { has_character_flag = sided_with_good }
		name = EVTOPTB_WCMDV_102
		narrative_event = { id = WCMDV.103 }
	}
}

#Arcanagos dead, Aegwynn banished
narrative_event = {
	id = WCMDV.103
	
	title = EVTTITLE_WCMDV_103
	desc = EVTDESC_WCMDV_103
	picture = GFX_evt_possessed_medivh
	border = GFX_event_narrative_frame_war
	
	is_triggered_only = yes
	
	portrait = c_60578
	
	immediate = {
		c_62605 = {
			death = {
				death_reason = death_battle
				killer = 5000
			}
		}
		narrative_event = { id = WCMDV.104 days = 3 }
	}
	
	option = {
		trigger = { has_character_flag = sided_with_sargeras }
		name = EVTOPTA_WCMDV_103
		add_15_fel_corruption_effect = yes
	}
	
	option = {
		trigger = { has_character_flag = sided_with_good }
		name = EVTOPTB_WCMDV_103
		add_15_fel_corruption_effect = yes
	}
}

#Here come's Khadgar
narrative_event = {
    id = WCMDV.104
	
	title = EVTTITLE_WCMDV_104
	desc = EVTDESC_WCMDV_104
	picture = GFX_evt_karazhan_tower
	border = GFX_event_narrative_frame_diplomacy
	
	is_triggered_only = yes
	
	immediate = {
	    c_59170 = { 
			move_character = ROOT
			save_event_target_as = student
			opinion = { modifier = opinion_teaching_me who = ROOT }
			set_character_flag = ask_to_be_mentor_ongoing_flag
			set_character_flag = training_mentor_mage_flag
			character_event = { id = WCCLS.2150 days = 1 }
		}
		ROOT = {
			save_event_target_as = mentor
		}
		narrative_event = { id = WCMDV.105 days = 1 }
	}
	
	option = {
		name = EVTOPTA_WCMDV_104
	}
}

#Khadgar in library
narrative_event = {
	id = WCMDV.105
	
	title = EVTTITLE_WCMDV_105
	desc = EVTDESC_WCMDV_105
	picture = GFX_evt_mage_in_library
	border = GFX_event_narrative_frame_diplomacy
	
	is_triggered_only = yes
	
	
	option = { #Evil path
		trigger = { has_character_flag = sided_with_sargeras }
		name = EVTOPTA_WCMDV_105
		narrative_event = { id = WCMDV.106 }
	}
	
	option = { #Good path
		trigger = { has_character_flag = sided_with_good }
		name = EVTOPTB_WCMDV_105
	}
	
	option = { #Canon path
		name = EVTOPTC_WCMDV_105
		narrative_event = { id = WCMDV.116 }
	}
}

#Khadgar is wounded
narrative_event = {
	id = WCMDV.106
	
	title = EVTTITLE_WCMDV_106
	desc = EVTDESC_WCMDV_106
	picture = GFX_evt_medivh_spell
	border = GFX_event_narrative_frame_war
	
	is_triggered_only = yes
	
	immediate = {
		if = { #if Garona is alive and capable
			limit = {
				c_10620 = {
					is_alive = yes
					is_incapable = no
				}
			}
			narrative_event = { id = WCMDV.107 days = 25 }
		}
		else = {
			narrative_event = { id = WCMDV.110 days = 50 }
		}
	}
	
	option = {
		name = EVTOPTA_WCMDV_106
		c_59170 = { add_trait = wounded }
	}
}

#Garona joins in
narrative_event = {
	id = WCMDV.107
	
	title = EVTTITLE_WCMDV_107
	desc = EVTDESC_WCMDV_107
	picture = GFX_evt_karazhan_tower
	border = GFX_event_narrative_frame_diplomacy
	
	is_triggered_only = yes
	
	portrait = c_10620
	
	option = {
		name = EVTOPTA_WCMDV_107
		narrative_event = { id = WCMDV.108 days = 5 }
	}
	
	option = {
		trigger = { NOT = { has_character_flag = sided_with_sargeras } }
		name = EVTOPTB_WCMDV_107
		c_10620 = {
			death = {
				death_reason = death_missing
			}
		}
		narrative_event = { id = WCMDV.117 days = 10 }
	}
}

#Garona falls in love with you
narrative_event = {
	id = WCMDV.108
	
	title = EVTTITLE_WCMDV_108
	desc = EVTDESC_WCMDV_108
	picture = GFX_evt_medivh_and_garona
	border = GFX_event_narrative_frame_diplomacy
	
	is_triggered_only = yes
	
	portrait = c_10620
	
	immediate = {
	    c_10620 = { add_lover = ROOT }
	}
	
	option = {
		trigger = { has_character_flag = sided_with_sargeras }
		name = EVTOPTA_WCMDV_108
		narrative_event = { id = WCMDV.109 }
	}
	
	option = {
		name = EVTOPTB_WCMDV_108
		narrative_event = { id = WCMDV.117 days = 5 }
	}
}

#You mind control Garona
narrative_event = {
	id = WCMDV.109
	
	title = EVTTITLE_WCMDV_109
	desc = EVTDESC_WCMDV_109
	picture = GFX_evt_mind_control
	border = GFX_event_narrative_frame_intrigue
	
	is_triggered_only = yes
	
	portrait = c_10620
	
	immediate = {
		c_10620 = {
			opinion = { modifier = opinion_loyal_servant who = ROOT }
		}
		set_character_flag = garona_controled
		narrative_event = { id = WCMDV.110 days = 20 }
	}
	
	option = {
		name = EXCELLENT
	}
}

#Time to take Khadgar to our side
narrative_event = {
	id = WCMDV.110
	
	title = EVTTITLE_WCMDV_110
	desc = EVTDESC_WCMDV_110
	picture = GFX_evt_khadgar_necromancer
	border = GFX_event_narrative_frame_intrigue
	
	is_triggered_only = yes
	
	portrait = c_59170
	
	immediate = {
		c_59170 = {
			add_trait_undead_effect = yes
			opinion = {
				modifier = opinion_loyal_servant
				who = ROOT
			}
			reset_experience_effect = yes
			remove_trait = class_mage_3
		}
	}
	
	option = {
		name = EVTOPTA_WCMDV_110
		c_59170 = {
			add_trait = class_necromancer_6
		}
		set_character_flag = khadgar_turned
		narrative_event = { id = WCMDV.111 days = 10 }
	}
}

#You join Sargeras
narrative_event = {
	id = WCMDV.111
	
	title = EVTTITLE_WCMDV_111
	desc = EVTDESC_WCMDV_111
	picture = GFX_evt_possessed_medivh
	border = GFX_event_narrative_frame_war
	
	is_triggered_only = yes
	
	immediate = {
		clr_character_flag = in_fight_with_sargeras
		if = {
			limit = { NOT = { has_global_flag = aegwynn_dead } }
			narrative_event = { id = WCMDV.112 days = 25 }
		}
		else = {
			character_event = { id = WCMDV.113 months = 1 }
		}
	}
	
	option = {
		name = EVTOPTA_WCMDV_111
		piety = -5
		add_35_fel_corruption_effect = yes
	}
}

#Fight with Aegwynn 
narrative_event = {
	id = WCMDV.112
	
	title = EVTTITLE_WCMDV_112
	desc = EVTDESC_WCMDV_112
	picture = GFX_evt_aegwynn_spell
	border = GFX_event_narrative_frame_war
	
	is_triggered_only = yes
	
	immediate = {
		#transfers Aluneth to Medivh(or should)
		c_60578 = {
			random_artifact = {
				limit = { artifact_type = aluneth }
				transfer_artifact = {
					from = c_60578
					to = c_5000
				}
			}
		}
	}
	
	option = {
		name = EVTOPTA_WCMDV_112
		prestige = 100
		add_35_fel_corruption_effect = yes
		c_60578 = {
			death = {
				death_reason = death_battle
				killer = 5000
			}
		}
		character_event = { id = WCMDV.113 days = 5 }
	}
}

#Time to take your rightful place
character_event = {
	id = WCMDV.113
	
	desc = EVTDESC_WCMDV_113
	picture = GFX_evt_possessed_medivh
	border = GFX_event_normal_frame_intrigue
	
	is_triggered_only = yes
	
	immediate = {
		#No one likes Medivh anymore
		c_5000 = {
			remove_friend = c_2
			remove_friend = c_1008
		}
		1858 = { save_event_target_as = target_summoning_location }		# Xonulzis
	}
	
	option = {
		name = EVTOPTA_WCMDV_113
		piety = 1000
		add_15_fel_corruption_effect = yes
		narrative_event = { id = WCMDV.114 months = 1 }
		give_nickname = nick_the_fallen_guardian
	}
}

#Medivh summons Legion and invades night elfs
narrative_event = {
	id = WCMDV.114
	title = EVTTITLE_WCMDV_114
	desc = EVTDESC_WCMDV_114
	picture = GFX_evt_burning_legion
	border = GFX_event_narrative_frame_war

	is_triggered_only = yes

	major = yes
	major_trigger = {
		ai = no
	}
	show_root = yes
	hide_new = yes

	immediate = {
		# Used in scripted effects
		save_event_target_as = target_settler
		
		73 = { province_event = { id = WCTHW.50 } } # When shit happens, Medivh tries to fix it
		
		wealth = 1000
		prestige = 1000
		piety = 250
		
		c_xonulzis = {
			# event_target:target_settler and its people settle here
			settle_as_target_settler_effect = yes
		}
		
		d_haldarr = {
			any_direct_de_jure_vassal_title = {
				# event_target:target_settler and its people settle here
				settle_as_target_settler_effect = yes
			}
		}

		activate_title = { title = e_burning_legion status = yes }
		e_burning_legion = { gain_title = ROOT }
		
		set_legion_government_effect = yes
		
		c_xonulzis = {
			# Declares war against player
			target_settler_declare_war_effect = yes
		}
		
		clear_settler_flag_effect = yes

		# Spawns troops
		spawn_legion_troops_effect = yes
		spawn_legion_troops_effect = yes
		spawn_legion_troops_effect = yes
		spawn_legion_troops_effect = yes
		spawn_legion_troops_effect = yes
		spawn_legion_troops_effect = yes
		spawn_legion_troops_effect = yes
		# Declares war against the night elves
		1921 = {
			holder_scope = {
				top_liege = {
					if = {
						limit = {
							is_untouchable_trigger = no

							NOT = { religion = burning_legion_religion }
							NOT = { true_religion = burning_legion_religion }
						}
						set_character_flag = event_war_exception_flag
						ROOT = {
							unsafe_war = {
								target = PREV
								casus_belli = total_invasion
								thirdparty_title = PREV
							}
						}
					}
				}
			}
		}
	}

	option = {
		name = {
			trigger = { OR = { true_religion = burning_legion_religion true_religion = orcish_fel } }
			text = EVTOPTA_WCFEL_1005_case_01
		}
		name = {
			trigger = { NOR = { true_religion = burning_legion_religion true_religion = orcish_fel } }
			text = EVTOPTA_WCFEL_1005_case_02
		}
	}
}

#Event that checks if Khadgar is alive and capable or not
character_event = {
	id = WCMDV.115
	
	is_triggered_only = yes
	hide_window = yes
	
	immediate = {
		if = {
			limit = {
				c_59170 = {
					is_alive = yes
					is_incapable = no
				}
			}
			narrative_event = { id = WCMDV.110 days = 20 }
		}
		else = {
			
		}
	}
}

#Shoo, Dalaran spy
narrative_event = {
	id = WCMDV.116
	
	title = EVTTITLE_WCMDV_116
	desc = EVTDESC_WCMDV_116
	picture = GFX_evt_mage_in_library
	border = GFX_event_narrative_frame_diplomacy
	
	is_triggered_only = yes
	
	immediate = {
		if = { #if Garona is alive and capable
			limit = {
				c_10620 = {
					is_alive = yes
					is_incapable = no
				}
			}
			narrative_event = { id = WCMDV.107 days = 25 }
		}
		else = {
			
		}
	}
	
	option = {
		name = EVTOPTA_WCMDV_116
	}
}

#Time to pay a visit to Stormwind
narrative_event = {
	id = WCMDV.117
	
	title = EVTTITLE_WCMDV_117
	desc = EVTDESC_WCMDV_117
	picture = GFX_evt_stormwind_champion
	border = GFX_event_narrative_frame_intrigue
	
	is_triggered_only = yes
	
	portrait = c_1008
	
	immediate = {
		add_trait = travelling
		c_59170 = { add_trait = travelling }
	}
	
	option = {
		trigger = { has_character_flag = sided_with_good }
		name = EVTOPTA_WCMDV_117
		narrative_event = { id = WCMDV.118 days = 15 }
	}
}

#Medivh came, but didn't help
narrative_event = {
	id = WCMDV.118
	
	title = EVTTITLE_WCMDV_118
	desc = EVTDESC_WCMDV_118
	picture = GFX_evt_lordaeron_coast
	border = GFX_event_narrative_frame_intrigue
	
	is_triggered_only = yes
	
	option = {
		name = EVTOPTA_WCMDV_118
		narrative_event = { id = WCMDV.119 = 10 days }
	}
}

#Siege of Stormwind
narrative_event = {
	id = WCMDV.119
	
	title = EVTTITLE_WCMDV_119
	desc = EVTDESC_WCMDV_119
	picture = GFX_evt_orcish_horde
	border = GFX_event_narrative_frame_war
	
	is_triggered_only = yes
	
	portrait = c_2
	
	immediate = {
		random_list = {
			75 = {
				narrative_event = { id = WCMDV.120 days = 3 }
			}
			25 = {
				narrative_event = { id = WCMDV.121 days = 3 }
			}
		}
	}
	
	option = {
		name = EVTOPTA_WCMDV_119
	}
}

#Blackhand won the duel
narrative_event = {
	id = WCMDV.120
	
	title = EVTTITLE_WCMDV_120
	desc = EVTDESC_WCMDV_120
	picture = GFX_evt_makgora
	border = GFX_event_narrative_frame_war
	
	is_triggered_only = yes
	
	portrait = c_10000
	
	immediate = {
		c_2 = {
			death = {
				death_reason = death_duel
				killer = c_10000
			}
		}
		c_10000 = { add_trait = scarred }
		random_province = {
			limit = {
				religion_group = light_group
				culture_group = human_group
				
				province_id = 1	# Stormwind
			}
			save_event_target_as = target_province
		}
	}
	
	option = {
		name = EVTOPTA_WCMDV_120
		narrative_event = { id = WCMDV.122 days = 5 }
	}
}

#Llane won the duel
narrative_event = {
	id = WCMDV.121
	
	title = EVTTITLE_WCMDV_121
	desc = EVTDESC_WCMDV_121
	picture = GFX_evt_warrior_human
	border = GFX_event_narrative_frame_war
	
	is_triggered_only = yes
	
	portrait = c_2
	
	immediate = {
		c_10000 = {
			death = {
				death_reason = death_duel
				killer = c_2
			}
		}
	}
	
	option = {
		name = EVTOPTA_WCMDV_121
		
	}
}

#Purge of Stormwind: Medivh event
narrative_event = {
	id = WCMDV.122
	
	title = EVTTITLE_WCMDV_122
	desc = EVTDESC_WCMDV_122
	picture = GFX_evt_orcish_horde
	border = GFX_event_narrative_frame_war
	
	is_triggered_only = yes
	
	immediate = {
		event_target:target_province = {
			add_max_depopulation_effect = yes
			hidden_effect = {
				province_event = { id = WCMDV.124 }
				any_province_character = {
					limit = {
						NOT = {
							character = c_8 
							character = c_1008
							character = c_60578
						}
						
						in_command = no
					}
					random = {
						chance = 60
						death = {
							death_reason = death_battle
							killer = c_10000
						}
					}
				}
			}
		}
	}
	
	option = {
		name = EVTOPTA_WCMDV_122
	}
}

#Purge of Stormwind: ping event
province_event = {
	id = WCMDV.124

	is_triggered_only = yes
	hide_window = yes

	immediate = {
		FROM = { narrative_event = { id = WCMDV.123 days = 1 } }
	}
}

$Purge of Stormwind: major event
narrative_event = {
	id = WCMDV.123
	
	title = EVTTITLE_WCMDV_123
	desc = EVTDESC_WCMDV_123
	picture = GFX_evt_culling
	border = GFX_event_narrative_frame_war
	
	is_triggered_only = yes

	major = yes
	major_trigger = {
		ai = no
	}
	show_from_from = yes
	
	option = {
		trigger = {
			NOT = { has_character_flag = is_medivh }
		}
		name = {
			trigger = {
				is_aggressive_trigger = no
			}
			text = EVTOPTA_WCMDV_123
		}
		name = {
			trigger = {
				is_aggressive_trigger = yes
			}
			text = EXCELLENT
		}
	}
	
	option = {
		trigger = { has_character_flag = is_medivh }
		name = EVTOPTB_WCMDV_123
	}
}